# 11. 쓰레드의 이해

## 스레드란?

- 많은 수의 프로세스 생성은 빈번한 컨텍스트 스위칭(프로세스는 독립적이기 때문)으로 이어져 성능에 영향을 미침
- 컨텍스트 스위칭을 줄이기 위해 스레드라는 개념이 탄생
- 스레드는 일부는 별개이고 일부는 공유하는 구조로 컨텍스트 스위칭 발생 시 저장하고 복원하는 정보를 줄여 컨텍스트 스위칭을 줄일 수 있음

### 프로세스와 스레드

- 프로세스 - 완전히 별개의 프로그램을 동시 실행하기 위해 독립된 구조를 가짐
- 스레드
  - 하나의 프로그램 내에서 여러 개의 실행 흐름을 두기 위한 모델
  - 프로세스처럼 완벽히 독립적인 구조가 아님. 스레드들 사이에는 공유하는 요소들이 있음
  - 스레드는 공유하는 요소가 있는 관계로 컨텍스트 스위칭에 걸리는 시간이 프로세스보다 짧다

### 메모리 관점에서의 프로세스와 스레드

- 프로세스 - 자식 프로세스를 생성하면 Code~Stack영역의 메모리 구조를 새로 생성함(독립적)
- 스레드 - 메모리의 Stack영역만 스레드만을 위한 스택을 생성할 뿐, 그 외의 영역은 부모 프로세스 영역을  공유하고 있음

### 스레드의 특성

1. 스레드마다 스택을 독립적으로 할당해줌
   - 스택은 함수 호출 시 전달되는 인자, 되돌아갈 주소값 및 함수 내에서 선언하는 변수 등을 저장하기 위한 메모리 공간으로, 스택공간이 독립적이면 실행흐름의 추가를 위한 최소 조건을 달성 가능함
2. 코드 영역을 공유함
   - 멀티 프로세스는 독립적이기 때문에 A프로세스의 main에서 B프로세스에 접근할 수 없지만, 스레드는 프로그램의 main외에도 스레드의 main함수가 생성되어 프로그램의 흐름이 늘어나고, 코드 영역에 존재하는 모든 함수를 실행할 수 있다
3. 데이터 영역과 힙을 공유한다
   - 스레드간의 힙과 데이터 영역을 공유하기 때문에 IPC가 필요 없어짐
   - 전역변수와 동적할당된 메모리 공간은 공유가 가능함
4. Windows입장에서 프로세스는 단순히 스레드를 담는 상자에 지나지 않음 -> 스케줄러가 실행의 단위로 선택하는 것도 스레드. 또한, Windows에서는 프로세스가 상태를 지니는 것이 아닌, 스레드가 상태를 지님



## 스레드 구현 모델에 따른 구분

### 커널 레벨 스레드와 유저 레벨 스레드

#### 커널 레벨 스레드

- 프로그래머 요청에 따라 스레드를 생성 및 스케줄링하는 주체가 커널인 경우
- 유저 영역 - 코드 영역, 데이터 영역, 스택 및 힙 영역과 같은 메모리 영역
- 커널 영역 - 프로세스에게 할당된 총 메모리 공간 중에서 유저 영역을 제외한 나머지 영역. 즉, 운영체제라는 하나의 소프트웨어를 실행시키기 위해서 필요한 메모리 공간
- 오늘날 대부분의 운영체제는 커널 레벨 스레드를 기반으로 스레드 모델을 지우너함

#### 유저 레벨 스레드 모델

- 커널에서 스레드 기능을 제공하지 않을 경우, 커널에 의존적이지 않은 형태로 스레드의 기능을 제공하는 라이브러리를 활용하는 방식
- 커널에서 제공하는 기능이 아니므로 실행 시 유저 영역에서 실행됨

#### 커널 영역

- 운영체제 또한 CPU 입장에서 보면 메모리에 올라가 실행되는 프로그램에 지나지 않음. 또한, CPU에 종속적인 부분을 제외하고 C언어로 구현되어 있음
- 따라서, 당연히 함수나 메모리 구조가 존재함.
- 프로세스에 할당되는 총 메모리 = 유저 영역(프로그램 실행 시 사용하게 되는 메모리) + 커널 영역(운영체제가 내부적으로 사용하게 되는 메모리)



### 커널 모드와 유저 모드

- 유저 영역에서 메모리 참조 오류가 발생한다면 실행 중인 프로그램에만 영향을 미치지만 커널 영역은 커널의 코드가 실행되는 영역이므로 시스템 전체에 문제를 일으킬 수 있다
- 모드의 전환(커널 모드와 유저 모드)은 시스템에 부담을 주는 일
- 커널 모드와 유저 모드를 제공하는 것인 프로세서로, 메모리 보호 기능이 CPU에 달려있음
- 커널 레벨 스레드의 장점 및 단점
  - 장점 - 커널에서 직접 제공해 주기 때문에 안전성과 다양한 기능성이 제공됨
  - 단점 - 커널에서 제공해 주는 기능이기 때문에 유저 모드에서 커널 모드로의 전환이 빈번하게 일어남. 따라서 성능 저하로 이어짐
- 유저 레벨 스레드의 장점 및 단점
  - 장점 - 커널은 스레드의 존재를 모르기 때문에 유저 모드에서 커널 모드로의 전환이 필요없다. 따라서 성능이 좋음
  - 단점 - 프로그래밍하기 어려워지고 커널 레벨 스레드에 비해 결과 예측이 어려움

