# 19. 비동기 I/O와 APC

## 비동기 I/O

- 블로킹 - 한 번 호출되면 완료될 때까지 블로킹되는 함수들
- 동기I/O - 블로킹 함수들을 활용한 입출력 연산

### Overlapped I/O

- 논블로킹 함수 - 작업의 완료에 상관없이 바로 반환해버리는 특성을 지님
- Overlapped I/O - 논블로킹 함수 호출을 통해서 여러 작업이 동시에 진행될 수 있음.(I/O연산이 중첩되어 실행되고 있음)

1. Overlapped I/O가능한 비동기 특성을 띄는 파이프나 소켓 등을 생성
2. Overlapped구조체 변수를 선언(hEvent 속성 오브젝트 - 입출력 연산이 완료되었음을 확인하기 위한 이벤트 오브젝트)
3. 파이프나 소켓 등을 생성 시 비동기로 호출하며 OVERLAPPED 구조체 변수의 포인터를 인자로 전달.
4. 논블로킹이기 때문에 3에 대한 리턴값이 NULL을 반환할 수 있기 때문에 무조건 오류로 취급하고 프로세스를 종료하면 안됨.
5. 중첩 I/O는 과도한 연산 요청을 받으면 병목현상이 발생할 수 있음. 따라서, 논블로킹 함수를 호출 후 그 결과가 오류 발생을 의미하는 NULL이라면 GetLastError함수 호출을 통해서 과도한 I/O 요청에 의한 문제인지, 아니면  보다 심각한 문제인지를 확인하고 이에 대한 처리를 달리 해야 함.
6. GetOverlappedResult 함수를 통해 내가 요청한 I/O연산이 잘 마무리 되었는지 확인
7. GetOverlappedResult의 버퍼사이즈 - 동기 방식 I/O연산에서 최종 목적지인 클라이언트에게로 데이터 전송이 완료되어야만 반환하는 구조가 아니라, 전송을 위해 할당된 내부 메모리 버퍼에 복사가 이뤄지고 나면 반환하는 구조이기 때문에, 전송할 데이터 크기보다 출력버퍼의 사이즈가 더 크다면 블로킹 되지 않고 바로 반환함

### 완료루틴 기반 확장 I/O

확장 I/O 제공 기능 = 중첩 I/O 제공 기능 + 알파(루틴 컨트롤을 자동으로 해줌)

- ~~Ex함수가 대상.
- 완료루틴 지정을 위한 매개변수가 추가로 선언되어있으며 파라미터에 완료 후 콜백 함수를 넣어주면 됨
- 콜백 함수 - Windows 시스템에 의해 자동으로 호출되는 함수

### 알림 가능한 상태(Alertable State)

- I/O연산이 완료되어서 완료루틴을 실행할 차례가 되면 바로 완료루틴이 실행되어야 할 텐데, Windows는 완료루틴 실행 타이밍을 개발자가 결정할 수 있도록 함.
- Ex) SleepEx(DWORD dwMilliseconds, bool bAlertable)함수의 두 번째 인자에 true를 전달하면 스레드가 Alertable State가 되는데 이 상태에서는 호출되어야 할 완료루틴의 호출이 이루어짐.
- 완료된 I/O가 없어서 호출할 완료루틴이 없거나 첫 번째 전달인자를 통해 전달된 시간도 지나지 않았다면 SleepEx함수는 계속 블로킹 상태에 놓이게 됨
- 첫 번째 전달인자로 지정한 시간이 다 되면 0을 반환하며 함수를 빠져 나오고, 완료 루틴이 실행되어 함수를 빠져나올 때는 WAIT_IO_COMPLETION을 반환함
- I/O연산이 끝나고 다음에 처리해야 할 일을 상황에 따라 뒤로 비룰 수 있음.
- 열 개의 I/O연산을 진행할 경우, 1~4의 호출 후 5의 호출 전에 1의 완료 루틴이 시작되면 5번째의 I/O연산을 실행하기에는 긴 시간이 소요됨..이럴 때 Alertable State를 사용하면 도움이 됨

### OVERLAPPED 구조체의 파일 위치 정보

- 비동기 I/O에서 커널 오브젝트에 존재하는 파일의 위치 정보는 의미가 없음
- OVERLAPPED 구조체의 멤버 중에서 일보는 데이터 입출력 시작 위치를 지정하는 용도로 사용됨(Offset, OffsetHigh)
- 따라서, 중첩 I/O로 파일 쓰기와 같은 작업을 수행할 경우, 프로그래머가 각 OVERLAPPED의 Offset 속성을 통해 파일 포인터의 위치를 정의해주어야 한다.

### 타이머에서의 완료루틴

- ```c++
  bool SetWaitableTimer(
  	HANDLE hTimer,
    	const LARGE_INTEGER* pDueTime,
    	LONG lPeriod,
    	PTIMERAPCROUTINE pfnCompletionRoutine, //완료 루틴 지정
    	bool fResume //타이머 완료루틴의 첫 번째 전달인자로 그대로 전달
  )
  ```



**Windows는 기본적으로 두 가지 방식의 비동기 I/O방식을 지원하고 있음. 하나는 Overlapped I/O방식이고, 또 하나는 완료루틴 확장 I/O방식**



## APC

비동기 호출 매커니즘

### APC의 구조

- User-mode APC
- Kernel-mode APC
- 모든 스레드는 자신만의 APC Queue를 갖고 있으며, 해당 Queue에는 ~Ex함수에 인자로 전달된 함수(완료루틴) 포인터와 매개변수 정보가 저장됨.
- 즉, APC Queue에는 비동기적으로 호출되어야 할 함수들과 매개변수 정보가 저장됨. 그러나 바로 호출되는 것은 아니고 스레드가 알림 가능 상태에 놓이게 될 때에 호출됨
- APC Queue가 스레드별로 독립적이기 때문에 완료루틴이라는 것 자체가 스레드별로 독립적인 매커니즘임

### APC Queue의 접근

APC Queue에 함수 정보를 전달할 수 있는 방법은 총 세가지임.

- WriteFileEx
- ReadFileEx
- SetWaitableTimer

그러나, QueueUserAPC()함수를 이용하면 호출하고자 하는 함수 정보를 전달할 수 있음